<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diary</title>
  <style>
    :root{--bg:#0b0f19;--card:#111a2e;--line:#1b2640;--muted:#9bb0e6;--fg:#e8eefc;--sub:#cbd7ff;--btn:#4c7dff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:#0b0f19cc;backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:800}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    input, textarea, select{width:100%;border-radius:12px;border:1px solid #22345f;background:#0c1326;color:var(--fg);padding:10px 12px}
    textarea{min-height:160px;resize:vertical}
    button{border:0;border-radius:12px;padding:10px 12px;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#1a2746}
    button.danger{background:#ff4c5e}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1}
    .pill{font-size:12px;color:#b8c7ff;background:#0c1326;border:1px solid #22345f;padding:6px 10px;border-radius:999px;display:inline-block}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{display:inline-flex;align-items:center;gap:6px;text-decoration:none}
    .list{display:grid;gap:10px}
    .item{padding:12px;border-radius:14px;border:1px solid var(--line);background:#0c1326}
    .item h3{margin:0 0 6px;font-size:16px}
    .item p{margin:0;color:var(--sub);white-space:pre-wrap}
    .right{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill{opacity:.9}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div>
      <div class="brand">Diary</div>
      <div class="muted">ä¿å­˜ï¼šãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆç«¯æœ«ã”ã¨ï¼‰ï½œåŒæœŸã—ãŸã„ã¨ãã¯ Export/Import</div>
    </div>
    <div class="nav">
      <a href="#/home"><button class="secondary">Home</button></a>
      <a href="#/edit"><button class="secondary">Write</button></a>
      <a href="#/export"><button class="secondary">Export</button></a>
    </div>
  </div>
</header>

<div class="wrap grid">
  <!-- HOME -->
  <section id="pageHome" class="grid">
    <div class="card grid">
      <div class="row">
        <div>
          <label class="muted">æ—¥ä»˜ã‚’é¸ã‚“ã§é–‹ã</label>
          <input id="homeDate" type="date">
        </div>
        <div>
          <label class="muted">ãã®æœˆã®ä¸€è¦§ã¸</label>
          <input id="homeMonth" type="month">
        </div>
      </div>
      <div class="row">
        <button id="openDateBtn">ã“ã®æ—¥ä»˜ã‚’æ›¸ã/é–‹ã</button>
        <button class="secondary" id="openMonthExportBtn">ã“ã®æœˆã‚’ã¾ã¨ã‚ã‚‹</button>
      </div>
      <div class="kpi" id="homeKpi"></div>
    </div>

    <div class="card grid">
      <div class="row">
        <div>
          <label class="muted">æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/æœ¬æ–‡/ã‚¿ã‚°ï¼‰</label>
          <input id="q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
        </div>
        <div>
          <label class="muted">ã‚¿ã‚°çµã‚Šè¾¼ã¿</label>
          <input id="tagFilter" placeholder="ä¾‹ï¼šä»•äº‹">
        </div>
      </div>
      <div class="muted" id="stats"></div>
      <div class="list" id="list"></div>
    </div>
  </section>

  <!-- EDIT -->
  <section id="pageEdit" class="grid hidden">
    <div class="card grid">
      <div class="row">
        <div>
          <label class="muted">æ—¥ä»˜</label>
          <input id="date" type="date">
        </div>
        <div>
          <label class="muted">æ°—åˆ†</label>
          <select id="mood">
            <option value="">-</option>
            <option>ğŸ˜„ æœ€é«˜</option>
            <option>ğŸ™‚ è‰¯ã„</option>
            <option>ğŸ˜ æ™®é€š</option>
            <option>ğŸ˜• å¾®å¦™</option>
            <option>ğŸ˜« ã—ã‚“ã©ã„</option>
          </select>
        </div>
        <div>
          <label class="muted">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
          <input id="tags" placeholder="ä»•äº‹, æ—…è¡Œ, å‹‰å¼·">
        </div>
      </div>

      <div class="row">
        <div>
          <label class="muted">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="title" placeholder="ä»Šæ—¥ã®ã¾ã¨ã‚">
        </div>
      </div>

      <div class="row">
        <div>
          <label class="muted">æœ¬æ–‡</label>
          <textarea id="body" placeholder="ã“ã“ã«æ—¥è¨˜ã‚’æ›¸ã"></textarea>
        </div>
      </div>

      <div class="row">
        <button id="saveBtn">ä¿å­˜ / æ›´æ–°</button>
        <button class="secondary" id="clearBtn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button class="danger" id="deleteBtn">ã“ã®æ—¥ä»˜ã‚’å‰Šé™¤</button>
      </div>

      <div class="muted">Tipï¼šã‚ã¨ã§è¦ç´„ã«ä½¿ã†ãªã‚‰ã€ç®‡æ¡æ›¸ãï¼ˆä»Šæ—¥ã‚„ã£ãŸ/æ°—ã¥ã/æ¬¡ã‚„ã‚‹ï¼‰ã«ã™ã‚‹ã¨å¼·ã„ã€‚</div>
    </div>
  </section>

  <!-- EXPORT -->
  <section id="pageExport" class="grid hidden">
    <div class="card grid">
      <div class="row">
        <div>
          <label class="muted">ç¯„å›²ï¼ˆFromï¼‰</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label class="muted">ç¯„å›²ï¼ˆToï¼‰</label>
          <input id="toDate" type="date">
        </div>
        <div>
          <label class="muted">æœˆã§æŒ‡å®šï¼ˆä»»æ„ï¼‰</label>
          <input id="exportMonth" type="month">
        </div>
      </div>
      <div class="row">
        <button id="buildBtn">ã¾ã¨ã‚ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ</button>
        <button class="secondary" id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
        <button class="secondary" id="downloadTxtBtn">TXTä¿å­˜</button>
      </div>

      <div class="row">
        <button class="secondary" id="backupBtn">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰</button>
        <button class="secondary" id="restoreBtn">å¾©å…ƒï¼ˆJSON Importï¼‰</button>
        <input id="importFile" class="hidden" type="file" accept="application/json">
      </div>
    </div>

    <div class="card grid">
      <div class="muted">ç”Ÿæˆçµæœï¼ˆã“ã®ã¾ã¾ChatGPTç­‰ã«è²¼ã£ã¦è¦ç´„ã•ã›ã‚‹ç”¨ï¼‰</div>
      <textarea id="exportText" class="mono" style="min-height:260px" placeholder="ã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™"></textarea>
    </div>
  </section>
</div>

<script>
  const KEY = "diary_entries_v2";

  const $ = (id) => document.getElementById(id);
  const pages = {
    home: $("pageHome"),
    edit: $("pageEdit"),
    export: $("pageExport"),
  };

  const els = {
    // home
    homeDate: $("homeDate"),
    homeMonth: $("homeMonth"),
    openDateBtn: $("openDateBtn"),
    openMonthExportBtn: $("openMonthExportBtn"),
    homeKpi: $("homeKpi"),
    q: $("q"),
    tagFilter: $("tagFilter"),
    stats: $("stats"),
    list: $("list"),

    // edit
    date: $("date"),
    mood: $("mood"),
    tags: $("tags"),
    title: $("title"),
    body: $("body"),
    saveBtn: $("saveBtn"),
    clearBtn: $("clearBtn"),
    deleteBtn: $("deleteBtn"),

    // export
    fromDate: $("fromDate"),
    toDate: $("toDate"),
    exportMonth: $("exportMonth"),
    buildBtn: $("buildBtn"),
    copyBtn: $("copyBtn"),
    downloadTxtBtn: $("downloadTxtBtn"),
    exportText: $("exportText"),
    backupBtn: $("backupBtn"),
    restoreBtn: $("restoreBtn"),
    importFile: $("importFile"),
  };

  const todayISO = () => new Date().toISOString().slice(0,10);

  function loadAll() {
    try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
    catch { return {}; }
  }
  function saveAll(map) {
    localStorage.setItem(KEY, JSON.stringify(map));
  }
  function normalizeTags(s){
    return (s||"").split(",").map(t=>t.trim()).filter(Boolean);
  }
  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[s]);
  }

  function setFormFromEntry(date, e){
    els.date.value = date;
    els.mood.value = e?.mood || "";
    els.tags.value = (e?.tags || []).join(", ");
    els.title.value = e?.title || "";
    els.body.value = e?.body || "";
  }

  function readForm(){
    const date = els.date.value || todayISO();
    return {
      date,
      mood: els.mood.value,
      tags: normalizeTags(els.tags.value),
      title: els.title.value.trim(),
      body: els.body.value.trim(),
      updatedAt: new Date().toISOString(),
    };
  }

  function showPage(name){
    Object.keys(pages).forEach(k => pages[k].classList.toggle("hidden", k!==name));
  }

  function parseHash(){
    // #/edit?date=2025-12-16 ã¿ãŸã„ãªã®ã‚’èª­ã‚€
    const h = location.hash || "#/home";
    const [path, query] = h.replace(/^#/, "").split("?");
    const params = new URLSearchParams(query || "");
    return { path, params };
  }

  function route(){
    const { path, params } = parseHash();
    if (path === "/edit") {
      showPage("edit");
      const d = params.get("date") || els.date.value || todayISO();
      const map = loadAll();
      setFormFromEntry(d, map[d]);
      els.date.value = d;
      return;
    }
    if (path === "/export") {
      showPage("export");
      // ã‚¯ã‚¨ãƒªã§month or range
      const month = params.get("month");
      if (month) {
        els.exportMonth.value = month;
        const [from,to] = monthToRange(month);
        els.fromDate.value = from;
        els.toDate.value = to;
      }
      return;
    }
    showPage("home");
    renderHome();
  }

  function monthToRange(ym){
    // ym: "2025-12" -> from "2025-12-01", to "2025-12-31"
    const [y,m] = ym.split("-").map(Number);
    const from = new Date(y, m-1, 1);
    const to = new Date(y, m, 0);
    return [toISO(from), toISO(to)];
  }
  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function entryToText(e){
    const tags = (e.tags||[]).map(t=>`#${t}`).join(" ");
    const head = `=== ${e.date}${e.mood ? " / " + e.mood : ""}${tags ? " / " + tags : ""} ===`;
    const title = e.title ? `ã€${e.title}ã€‘` : "";
    return [head, title, e.body||"", ""].filter(Boolean).join("\n");
  }

  function buildExportText(from, to){
    const map = loadAll();
    const entries = Object.entries(map)
      .map(([date,e]) => ({...e, date}))
      .filter(e => (!from || e.date >= from) && (!to || e.date <= to))
      .sort((a,b) => a.date.localeCompare(b.date));
    const header = `Diary Export\nRange: ${from || "-"} to ${to || "-"}\nCount: ${entries.length}\n`;
    return header + "\n" + entries.map(entryToText).join("\n");
  }

  function renderHome(){
    const map = loadAll();
    const allDates = Object.keys(map).sort();
    const count = allDates.length;
    const last = allDates[allDates.length-1] || "-";
    const first = allDates[0] || "-";
    els.homeKpi.innerHTML = `
      <span class="pill">ä»¶æ•°: ${count}</span>
      <span class="pill">æœ€å¤: ${first}</span>
      <span class="pill">æœ€æ–°: ${last}</span>
    `;
    renderList();
  }

  function renderList(){
    const map = loadAll();
    const q = (els.q.value||"").trim().toLowerCase();
    const tf = (els.tagFilter.value||"").trim().toLowerCase();

    const entries = Object.entries(map)
      .map(([date, e]) => ({...e, date}))
      .sort((a,b) => b.date.localeCompare(a.date));

    const filtered = entries.filter(e => {
      const hay = `${e.title||""}\n${e.body||""}\n${(e.tags||[]).join(",")}`.toLowerCase();
      if (q && !hay.includes(q)) return false;
      if (tf && !(e.tags||[]).some(t => t.toLowerCase().includes(tf))) return false;
      return true;
    });

    els.stats.textContent = `ä»¶æ•°: ${filtered.length} / å…¨${entries.length}`;

    els.list.innerHTML = "";
    filtered.forEach(e => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div class="pill">${e.date}${e.mood ? " ãƒ»" + e.mood : ""}</div>
          <div class="muted">${e.updatedAt ? "æ›´æ–°: " + new Date(e.updatedAt).toLocaleString() : ""}</div>
        </div>
        <h3>${escapeHtml(e.title || "(ç„¡é¡Œ)")}</h3>
        <div class="muted">${(e.tags||[]).map(t => "#" + escapeHtml(t)).join(" ")}</div>
        <p style="margin-top:8px;">${escapeHtml((e.body||"").slice(0,220))}${(e.body||"").length>220?"â€¦":""}</p>
        <div class="row" style="margin-top:10px;">
          <a href="#/edit?date=${encodeURIComponent(e.date)}" style="flex:1;text-decoration:none"><button class="secondary" style="width:100%">ã“ã®æ—¥ã‚’é–‹ã</button></a>
          <a href="#/export?month=${encodeURIComponent(e.date.slice(0,7))}" style="flex:1;text-decoration:none"><button class="secondary" style="width:100%">ã“ã®æœˆã‚’ã¾ã¨ã‚ã‚‹</button></a>
        </div>
      `;
      els.list.appendChild(div);
    });
  }

  // init defaults
  els.homeDate.value = todayISO();
  els.date.value = todayISO();
  els.homeMonth.value = todayISO().slice(0,7);
  els.exportMonth.value = todayISO().slice(0,7);
  const [df, dt] = monthToRange(els.exportMonth.value);
  els.fromDate.value = df;
  els.toDate.value = dt;

  // HOME actions
  els.openDateBtn.addEventListener("click", () => {
    const d = els.homeDate.value || todayISO();
    location.hash = `#/edit?date=${encodeURIComponent(d)}`;
  });
  els.openMonthExportBtn.addEventListener("click", () => {
    const m = els.homeMonth.value || todayISO().slice(0,7);
    location.hash = `#/export?month=${encodeURIComponent(m)}`;
  });

  // SEARCH
  [els.q, els.tagFilter].forEach(el => el.addEventListener("input", renderList));

  // EDIT: date change loads entry
  els.date.addEventListener("change", () => {
    const d = els.date.value || todayISO();
    const map = loadAll();
    setFormFromEntry(d, map[d]);
    // URLã‚‚åˆã‚ã›ã‚‹
    location.hash = `#/edit?date=${encodeURIComponent(d)}`;
  });

  els.saveBtn.addEventListener("click", () => {
    const e = readForm();
    if (!e.body && !e.title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‹æœ¬æ–‡ã‚’å…¥ã‚Œã¦");
    const map = loadAll();
    map[e.date] = e;
    saveAll(map);
    alert("ä¿å­˜ã—ãŸ");
  });

  els.clearBtn.addEventListener("click", () => {
    els.mood.value = "";
    els.tags.value = "";
    els.title.value = "";
    els.body.value = "";
  });

  els.deleteBtn.addEventListener("click", () => {
    const d = els.date.value || todayISO();
    const map = loadAll();
    if (!map[d]) return alert("ã“ã®æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ãªã„");
    if (!confirm(`${d} ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ`)) return;
    delete map[d];
    saveAll(map);
    setFormFromEntry(d, null);
    alert("å‰Šé™¤ã—ãŸ");
  });

  // EXPORT: month changes -> set range
  els.exportMonth.addEventListener("change", () => {
    const m = els.exportMonth.value;
    if (!m) return;
    const [from,to] = monthToRange(m);
    els.fromDate.value = from;
    els.toDate.value = to;
    // URLã‚‚åˆã‚ã›ã‚‹
    location.hash = `#/export?month=${encodeURIComponent(m)}`;
  });

  els.buildBtn.addEventListener("click", () => {
    const from = els.fromDate.value || "";
    const to = els.toDate.value || "";
    els.exportText.value = buildExportText(from, to);
  });

  els.copyBtn.addEventListener("click", async () => {
    const text = els.exportText.value.trim();
    if (!text) return alert("å…ˆã«ç”Ÿæˆã—ã¦");
    try{
      await navigator.clipboard.writeText(text);
      alert("ã‚³ãƒ”ãƒ¼ã—ãŸ");
    }catch{
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ï¼‰");
    }
  });

  els.downloadTxtBtn.addEventListener("click", () => {
    const text = els.exportText.value.trim();
    if (!text) return alert("å…ˆã«ç”Ÿæˆã—ã¦");
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `diary_export_${todayISO()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Backup/Restore (JSON)
  els.backupBtn.addEventListener("click", () => {
    const data = localStorage.getItem(KEY) || "{}";
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `diary_backup_${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  els.restoreBtn.addEventListener("click", () => els.importFile.click());
  els.importFile.addEventListener("change", async () => {
    const file = els.importFile.files?.[0];
    if (!file) return;
    const text = await file.text();
    let obj;
    try { obj = JSON.parse(text); } catch { return alert("JSONãŒå£Šã‚Œã¦ã‚‹"); }
    if (typeof obj !== "object" || obj === null || Array.isArray(obj)) return alert("å½¢å¼ãŒé•ã†");
    saveAll(obj);
    alert("å¾©å…ƒã—ãŸï¼ˆç«¯æœ«å†…ã«åæ˜ ï¼‰");
    els.importFile.value = "";
    // ç”»é¢æ›´æ–°
    if ((location.hash||"").startsWith("#/home")) renderHome();
  });

  // Routing
  window.addEventListener("hashchange", route);
  if (!location.hash) location.hash = `#/edit?date=${encodeURIComponent(todayISO())}`;
route();
</script>
</body>
</html>
